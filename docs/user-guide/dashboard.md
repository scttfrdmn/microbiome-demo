# Microbiome Dashboard Guide

The microbiome dashboard is designed to display real-time results from the Nextflow workflow pipeline. This guide explains how the dashboard works and how it connects to the real data generated by the pipeline.

## Accessing the Dashboard

When you run `./start_demo.sh`, the script will output a URL for the dashboard. This URL is accessible only from your current IP address for security reasons. Open the URL in a web browser to access the dashboard.

```
Dashboard URL: http://microbiome-demo-dashboard-XXXXXXXXXX.s3-website-us-east-1.amazonaws.com/
```

## Dashboard Overview

The dashboard displays:

1. **Pipeline Progress** - Shows the current progress of the workflow, including completed samples and status
2. **Taxonomy Distribution** - Displays the phylum-level distribution of microbiome samples
3. **Sample Distribution** - Shows the count of samples by body site
4. **Resource Utilization** - Charts the CPU, memory, and GPU utilization over time

## Data Flow Architecture

The dashboard operates through the following data flow:

```
Nextflow Pipeline → S3 Bucket → Dashboard
```

1. **Data Generation**:
   - The Nextflow pipeline `microbiome_main.nf` processes metagenomic samples
   - Key processes include:
     - `taxonomic_classification_kraken` - Classifies reads taxonomically
     - `diversity_analysis` - Calculates alpha and beta diversity metrics
     - `create_summary` - Generates a comprehensive JSON summary file

2. **Data Storage**:
   - All results are stored in the S3 bucket specified during setup
   - Key output files include:
     - `results/summary/microbiome_summary.json` - Main summary file with taxonomy data
     - `status/progress.json` - Pipeline progress information
     - `monitoring/resources.json` - Resource utilization metrics

3. **Dashboard Display**:
   - The web dashboard fetches data directly from the S3 bucket
   - Refreshes automatically every 5 seconds to show real-time updates
   - Uses Chart.js to visualize the data

## Real Data Connection

The dashboard connects to real data in the following ways:

1. **Configuration**:
   - `dashboard_config.js` contains settings for S3 paths and environment
   - During deployment, `start_demo.sh` configures the correct bucket and paths

2. **Data Fetching**:
   - The dashboard uses `fetchData()` function to retrieve data from S3
   - Data is fetched using no-cache headers to ensure fresh content

3. **Data Processing**:
   - `processMicrobiomeSummary()` in `microbiome_dashboard.js` handles the real data format
   - Converts the pipeline output into the format needed for charts

## Summary Data Structure

The `microbiome_summary.json` file contains the following structure:

```json
{
  "taxonomic_profile": {
    "sample_count": 100,
    "species_count": 3524,
    "top_species": [ ... ],
    "phylum_distribution": [ ... ]
  },
  "functional_profile": {
    "pathway_count": 897,
    "top_pathways": [ ... ]
  },
  "diversity": {
    "alpha": { ... },
    "beta": { ... },
    "by_site": { ... }
  },
  "execution_metrics": { ... },
  "cost_analysis": { ... }
}
```

## Dashboard Features

The dashboard includes several enhanced features to improve your experience:

### 1. Real-time Data Refreshing

The dashboard automatically refreshes data every 5 seconds to show the latest information from the pipeline. You can also manually refresh the data:

- Click the "Refresh Data Now" button to immediately update the visualizations.
- A visual indicator shows when data is being updated.
- The "Last Updated" timestamp indicates when the data was last refreshed.

### 2. Debug Information

For troubleshooting, the dashboard includes a debug panel:

- Click the "Toggle Debug Info" button at the bottom to show/hide the debug panel.
- This shows all data fetch operations, processing steps, and any errors that occur.
- Useful for developers or when troubleshooting connection issues.

## Setup and Deployment

To deploy the dashboard:

1. Run the setup script:
   ```
   ./setup.sh <bucket-name> <region>
   ```

2. Prepare sample data:
   ```
   ./prepare_microbiome_data.sh
   ```

3. Start the demo:
   ```
   ./start_demo.sh
   ```

The `start_demo.sh` script will:
- Configure the dashboard with the correct S3 paths
- Deploy the dashboard to an S3 bucket configured for website hosting
- Set appropriate security and CORS settings
- Invoke the Lambda function to start the workflow

## Troubleshooting

If you encounter issues with the dashboard:

1. **Check S3 Permissions**:
   - Ensure the S3 bucket has public website access enabled
   - Check that the bucket policy allows getting objects

2. **Verify Pipeline Execution**:
   - Check the AWS Batch console to ensure the jobs are running
   - Look at CloudWatch logs for any errors

3. **Inspect Data Files**:
   - Directly examine the S3 bucket to verify the JSON files exist
   - Check file formats and contents for errors

4. **Debug Locally**:
   - Use the `test-dashboard.html` file with local test data
   - Enable debug info by clicking "Toggle Debug Info"

## Security

The dashboard is secured in the following ways:

- **IP Restriction**: Only accessible from the IP address used when running `./start_demo.sh`.
- **No Sensitive Data**: The dashboard doesn't display any sensitive AWS credentials or personal information.
- **Read-Only**: The dashboard is read-only and cannot make changes to your AWS resources.

## Testing

For developers, a test version of the dashboard is included:

- `test-dashboard.html` - A version of the dashboard that works with local test data
- `/dashboard/data/update_real_data.sh` - Script to update local data files with realistic data

This enables testing dashboard functionality without needing to run the entire pipeline.